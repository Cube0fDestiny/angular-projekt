services:
  # --- GŁÓWNE WEJŚCIE DO APLIKACJI (REVERSE PROXY) ---
  caddy:
    image: caddy:2-alpine
    container_name: caddy_proxy
    restart: unless-stopped
    ports:
      - "80:80"   # Port HTTP
      - "443:443" # Port HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - gateway
      - frontend

  # --- FRONTEND ANGULAR ---
  frontend:
    image: noka993/frontend:latest # Użyj swojej nazwy z Docker Hub
    container_name: frontend
    restart: unless-stopped

  # --- API GATEWAY (serwis wewnętrzny) ---
  gateway:
    image: noka993/gateway:latest
    container_name: gateway
    restart: unless-stopped
    environment:
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}

  # --- BROKER WIADOMOŚCI ---
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq/
    restart: unless-stopped

  # --- MIKROSERWISY ---
  user-service:
    image: noka993/user-service:latest
    container_name: user_service
    restart: unless-stopped
    environment:
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}

  post-service:
    image: noka993/post-service:latest
    container_name: post_service
    restart: unless-stopped
    environment:
      - PORT=3002
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    depends_on:
      - rabbitmq

  event-service:
    image: noka993/event-service:latest
    container_name: event_service
    restart: unless-stopped
    environment:
      - PORT=3003
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    depends_on:
      - rabbitmq

  image-service:
    image: noka993/image-service:latest
    container_name: image_service
    restart: unless-stopped
    environment:
      - PORT=3004
      - JWT_SECRET=${JWT_SECRET}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}

  group-service:
    image: noka993/group-service:latest
    container_name: group_service
    restart: unless-stopped
    environment:
      - PORT=3005
      - JWT_SECRET=${JWT_SECRET}
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}

  chat-service:
    image: noka993/chat-service:latest
    container_name: chat_service
    restart: unless-stopped
    environment:
      - PORT=3006
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:5672
      - DB_HOST=${DB_HOST}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${DB_NAME}
    depends_on:
      - rabbitmq

volumes:
  caddy_data:
  caddy_config:
  rabbitmq-data:
