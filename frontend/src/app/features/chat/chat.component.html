<div class="min-h-screen flex flex-col bg-[var(--o-bwhite)]">
  <app-navbar location="chat"></app-navbar>
  
  <!-- Main Container -->
  <div class="flex-1 flex flex-col lg:flex-row p-3 sm:p-4 md:p-6 gap-3 sm:gap-4 md:gap-6 max-w-7xl w-full mx-auto mt-16 sm:mt-18 md:mt-20">
    
    <!-- Chat List Sidebar -->
    <div 
      class="w-full lg:w-80 lg:min-w-[300px] bg-white rounded-xl sm:rounded-2xl shadow-sm border border-[var(--o-beige)] flex flex-col overflow-hidden
             lg:h-[calc(100vh-140px)] lg:min-h-[500px]"
      [ngClass]="{
        'max-h-[200px] sm:max-h-[250px]': isShowingMessages && isMobileView,
        'min-h-[250px] sm:min-h-[300px]': !isShowingMessages || !isMobileView,
        'hidden': isShowingMessages && isMobileView
      }"
    >
      
      <!-- Header -->
      <div class="p-3 sm:p-4 md:p-5 border-b border-[var(--o-beige)] bg-gradient-to-r from-[var(--o-beige)] to-transparent shrink-0">
        <div class="flex items-center justify-between">
          <h2 class="text-base sm:text-lg font-bold text-[var(--o-green)] flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
              <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
            </svg>
            Messages
          </h2>
          <span *ngIf="chats.length > 0" class="bg-[var(--o-beige)] text-[var(--o-green)] text-xs font-semibold px-2 py-0.5 sm:px-2.5 sm:py-1 rounded-full">
            {{ chats.length }}
          </span>
        </div>
      </div>
      
      <!-- Empty State -->
      <div *ngIf="!isShowingChats" class="flex-1 flex flex-col items-center justify-center p-4 sm:p-6 text-[var(--o-green)] opacity-60">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 sm:h-12 sm:w-12 mb-2 sm:mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <p class="text-xs sm:text-sm font-medium">No conversations yet</p>
        <p class="text-[10px] sm:text-xs mt-1">Start chatting with someone!</p>
      </div>

      <!-- Chat List -->
      <div *ngIf="isShowingChats" class="flex-1 overflow-y-auto p-1.5 sm:p-2 space-y-1 scrollbar-thin">
        <div 
          *ngFor="let chat of chats; trackBy: trackByChatId" 
          class="group flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 border-2"
          [ngClass]="{
            'bg-[var(--o-dbeige)] border-[var(--o-orange)] shadow-sm': chat.id === activeChatId,
            'bg-[var(--o-bwhite)] border-transparent hover:bg-[var(--o-beige)] hover:border-[var(--o-beige)]': chat.id !== activeChatId
          }"
          (click)="selectChat(chat)"
        >
          <!-- Avatar -->
          <div 
            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm shrink-0"
            [ngClass]="chat.id === activeChatId ? 'bg-[var(--o-orange)]' : 'bg-[var(--o-green)]'"
          >
            {{ getInitials(formatChatName(chat.name)) }}
          </div>
          
          <!-- Chat Info -->
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-[var(--o-green)] truncate text-xs sm:text-sm">
              {{ formatChatName(chat.name) }}
            </p>
            <p class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-60 truncate">
              Tap to view messages
            </p>
          </div>
          
          <!-- Delete Button -->
          <div (click)="$event.stopPropagation()" class="opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
            <button 
              (click)="deleteChat(chat)"
              class="p-1.5 sm:p-2 rounded-lg text-red-500 hover:bg-red-100 hover:text-red-600 transition-colors"
              title="Delete chat"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 sm:h-4 sm:w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Message Section -->
    <div 
      class="flex-1 bg-white rounded-xl sm:rounded-2xl shadow-sm border border-[var(--o-beige)] flex flex-col overflow-hidden
             lg:h-[calc(100vh-140px)] lg:min-h-[500px] min-h-[350px] sm:min-h-[400px]"
    >
      
      <!-- Back Button (Mobile Only) -->
      <div *ngIf="isShowingMessages && isMobileView" class="p-2 border-b border-[var(--o-beige)] lg:hidden shrink-0">
        <button 
          (click)="goBackToChats()"
          class="flex items-center gap-2 text-[var(--o-green)] hover:text-[var(--o-orange)] transition-colors text-sm font-medium"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
          </svg>
          Back to chats
        </button>
      </div>

      <!-- Chat Header (when chat is selected) -->
      <div *ngIf="isShowingMessages && otherUser" class="p-3 sm:p-4 border-b border-[var(--o-beige)] bg-gradient-to-r from-[var(--o-dbeige)] to-transparent shrink-0">
        <div class="flex items-center gap-2 sm:gap-3">
          <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-[var(--o-orange)] flex items-center justify-center text-white font-bold text-xs sm:text-sm shrink-0">
            {{ getInitials(otherUser.name + ' ' + otherUser.surname) }}
          </div>
          <div class="min-w-0 flex-1">
            <h3 
              class="font-semibold text-[var(--o-green)] hover:text-[var(--o-orange)] cursor-pointer transition-colors text-sm sm:text-base truncate"
              (click)="goToProfile(otherUser.id)"
            >
              {{ otherUser.name }} {{ otherUser.surname }}
            </h3>
            <p class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-60">Tap name to view profile</p>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isShowingMessages" class="flex-1 flex flex-col items-center justify-center p-4 sm:p-8">
        <div class="w-14 h-14 sm:w-20 sm:h-20 rounded-full bg-[var(--o-beige)] flex items-center justify-center mb-3 sm:mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 sm:h-10 sm:w-10 text-[var(--o-green)] opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>
        <h3 class="text-base sm:text-lg font-semibold text-[var(--o-green)] mb-1">Select a conversation</h3>
        <p class="text-xs sm:text-sm text-[var(--o-green)] opacity-60 text-center max-w-xs px-4">
          Choose a chat from the list to start messaging
        </p>
      </div>

      <!-- Messages Container -->
      <div 
        *ngIf="isShowingMessages" 
        class="flex-1 p-3 sm:p-4 md:p-6 overflow-y-auto space-y-3 sm:space-y-4 bg-gradient-to-b from-[var(--o-bwhite)] to-white scrollbar-thin"
        #messagesContainer
      >
        <!-- No messages yet -->
        <div *ngIf="messages.length === 0" class="flex flex-col items-center justify-center h-full text-[var(--o-green)] opacity-60">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 sm:h-12 sm:w-12 mb-2 sm:mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
          </svg>
          <p class="text-xs sm:text-sm font-medium">No messages yet</p>
          <p class="text-[10px] sm:text-xs mt-1">Send a message to start the conversation!</p>
        </div>

        <ng-container *ngFor="let message of messages; let i = index; trackBy: trackByMessageId">
          
          <!-- Date Separator -->
          <div *ngIf="shouldShowDateSeparator(message, i)" class="flex items-center gap-2 sm:gap-4 my-4 sm:my-6">
            <div class="flex-1 h-px bg-[var(--o-beige)]"></div>
            <span class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-60 font-medium px-2 whitespace-nowrap">{{ formatMessageDate(message.created_at) }}</span>
            <div class="flex-1 h-px bg-[var(--o-beige)]"></div>
          </div>

          <!-- Current User's Message -->
          <div *ngIf="message.creator_id === currentUser?.id" class="flex justify-end message-animation">
            <div class="flex flex-col max-w-[85%] sm:max-w-[75%] md:max-w-[65%] items-end">
              <div class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-60 mb-1 sm:mb-1.5 mr-2 font-medium">
                You
              </div>
              <div class="bg-gradient-to-br from-[var(--o-orange)] to-[var(--o-dorange)] text-white rounded-2xl rounded-tr-sm px-3 py-2 sm:px-4 sm:py-2.5 shadow-sm">
                <p class="text-xs sm:text-sm leading-relaxed break-words whitespace-pre-wrap">{{ message.text }}</p>
              </div>
              <span *ngIf="message.created_at" class="text-[9px] sm:text-[10px] text-[var(--o-green)] opacity-50 mt-1 mr-2">
                {{ formatTime(message.created_at) }}
              </span>
            </div>
          </div>

          <!-- Other User's Message -->
          <div *ngIf="message.creator_id !== currentUser?.id" class="flex justify-start message-animation">
            <div class="flex flex-col max-w-[85%] sm:max-w-[75%] md:max-w-[65%]">
              <div 
                class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-60 mb-1 sm:mb-1.5 ml-2 font-medium cursor-pointer hover:text-[var(--o-orange)] hover:opacity-100 transition-colors"
                (click)="goToProfile(otherUser!.id)"
              >
                {{ otherUser?.name }} {{ otherUser?.surname }}
              </div>
              <div class="bg-[var(--o-beige)] text-[var(--o-green)] rounded-2xl rounded-tl-sm px-3 py-2 sm:px-4 sm:py-2.5">
                <p class="text-xs sm:text-sm leading-relaxed break-words whitespace-pre-wrap">{{ message.text }}</p>
              </div>
              <span *ngIf="message.created_at" class="text-[9px] sm:text-[10px] text-[var(--o-green)] opacity-50 mt-1 ml-2">
                {{ formatTime(message.created_at) }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Message Input -->
      <div *ngIf="isShowingMessages" class="p-2 sm:p-3 md:p-4 border-t border-[var(--o-beige)] bg-[var(--o-bwhite)] shrink-0">
        <form 
          (ngSubmit)="createMessage()" 
          #messageForm="ngForm"
          class="flex items-center gap-2 sm:gap-3"
        >
          <!-- Emoji Button (hidden on very small screens) -->
          <button 
            type="button" 
            class="hidden sm:flex p-2 rounded-full text-[var(--o-green)] opacity-60 hover:opacity-100 hover:bg-[var(--o-beige)] transition-all"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd" />
            </svg>
          </button>

          <!-- Input Field -->
          <div class="flex-1 relative">
            <input
              type="text"
              [(ngModel)]="newMessageText"
              name="newMessageText"
              placeholder="Type your message..."
              required
              autocomplete="off"
              class="w-full px-3 py-2 sm:px-4 sm:py-2.5 md:px-5 md:py-3 bg-white text-[var(--o-green)] border border-[var(--o-beige)] rounded-full 
                     focus:outline-none focus:ring-2 focus:ring-[var(--o-orange)] focus:border-transparent 
                     placeholder:text-[var(--o-green)] placeholder:opacity-40 transition-all duration-200 text-xs sm:text-sm"
              (keydown.enter)="createMessage()"
            >
          </div>

          <!-- Send Button -->
          <button 
            type="submit" 
            [disabled]="!messageForm.valid"
            class="p-2 sm:p-2.5 md:p-3 rounded-full bg-gradient-to-r from-[var(--o-orange)] to-[var(--o-dorange)] text-white 
                   shadow-md hover:shadow-lg hover:from-[var(--o-dorange)] hover:to-[var(--o-orange)]
                   disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md
                   transition-all duration-200 transform hover:scale-105 active:scale-95 shrink-0"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
          </button>
        </form>
        
        <!-- Typing indicator placeholder -->
        <div class="mt-1 sm:mt-2 h-3 sm:h-4">
          <p *ngIf="isTyping" class="text-[10px] sm:text-xs text-[var(--o-green)] opacity-50 ml-2 sm:ml-12">
            {{ otherUser?.name }} is typing...
          </p>
        </div>
      </div>
    </div>
  </div>
</div>